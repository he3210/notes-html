<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 2021-08-20 Fri 15:39 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>doki v2.8基于宝箱的活动</title>
<meta name="generator" content="Org mode">
<meta name="author" content="时中贺">
<link rel="stylesheet" type="text/css" href="http://www.langdebuqing.com/css/style.css" />
<link rel="shortcut icon" href="http://www.langdebuqing.com/images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="preamble" class="status">
<div id="navbar">
    <ul>
        <li id="site-master"><a href="http://www.langdebuqing.com">浪的不轻</a></li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/gallery.html">Gallery</a> </li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/notebooks.html">Notebooks</a> </li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/links.html">Links</a> </li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/about.html">About</a> </li>
        <li class="search">
            <form action="http://google.com/search" method="get" accept-charset="utf-8">
                <input type="search" id="search" name="q" autocomplete="off" maxlength="30" placeholder="Google..">
                <input type="hidden" name="q" value="site:www.langdebuqing.com">
            </form>
        </li>
    </ul>
</div>
</div>
<div id="content">
<h1 class="title">doki v2.8基于宝箱的活动</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6417145">1. 需求</a>
<ul>
<li><a href="#orgc9a6b66">1.1. A SS SSS SSS+ 多种集齐难度，每种难度对应一个分值，集齐后分值计入排行榜</a></li>
<li><a href="#orgb9a5474">1.2. 榜单中昨日幸运直播间是啥？</a></li>
<li><a href="#org2335fa5">1.3. 榜单</a></li>
<li><a href="#org487aad7">1.4. icon 弹窗</a></li>
<li><a href="#orgd97780a">1.5. 在本小时内，若有主播已集齐，则进行新一轮集齐任务。</a></li>
<li><a href="#orgfb2c5da">1.6. 集礼物。主播给用户送，用户给主播送，均计算在内</a></li>
<li><a href="#org86be038">1.7. 直播间最幸运用户头像框 + 最幸运家族背景图。如果主播是昨日排行榜第一名，加边框一天</a></li>
<li><a href="#orgec9b00e">1.8. 两轮集齐有时间间隔 20s，20s之后才生成下一轮礼物集合</a></li>
<li><a href="#orgeefb01a">1.9. 历史记录只提供 30条，分页 10个</a></li>
<li><a href="#org7f41b58">1.10. 贡献详情：按单价、贡献时间排序。仅x1，不可能x2以上。礼物图片x1</a></li>
</ul>
</li>
<li><a href="#orgd9ac3e9">2. 数据结构</a>
<ul>
<li><a href="#org9c0de77">2.1. 更改吸金主播表</a></li>
<li><a href="#orgec271f0">2.2. 当前任务</a></li>
<li><a href="#orgc928a70">2.3. 收集历史表</a></li>
<li><a href="#org83db5bb">2.4. 个人任务完成情况</a></li>
</ul>
</li>
<li><a href="#orgbe93721">3. 实现</a>
<ul>
<li><a href="#orgfc4f028">3.1. 集齐历史记录及贡献榜。礼物集齐的每小时历史，点击展示贡献名单</a></li>
<li><a href="#orgc2d7102">3.2. 主播集齐次数日榜</a></li>
<li><a href="#org4b5c523">3.3. 本小时主播集齐度的一个排行榜</a></li>
<li><a href="#org8dc77d5">3.4. 获取本小时礼物集合函数</a>
<ul>
<li><a href="#org0cae88b">3.4.1. 根据规则挑选本小时礼物集合</a></li>
<li><a href="#org72a8c8d">3.4.2. 需要王珏提供函数：获取当前小时可开出的礼物，数据格式如下：</a></li>
</ul>
</li>
<li><a href="#orgb67da63">3.5. 收礼模块，用于集礼物</a></li>
<li><a href="#orgcb95889">3.6. 定时任务下发icon</a></li>
<li><a href="#orgb03902b">3.7. 直播间弹窗；获取本小说礼物集合http接口</a></li>
<li><a href="#orgb7eee27">3.8. 直播间内最幸运用户头像框</a></li>
<li><a href="#org7a61603">3.9. 任务创建</a></li>
</ul>
</li>
<li><a href="#org77da487">4. 上线</a>
<ul>
<li><a href="#org1a1a3a5">4.1. 确定主播给观众送礼能否不用。获取送礼队列时需要去掉 True。去掉一些日志</a></li>
</ul>
</li>
<li><a href="#org373a524">5. 需求</a></li>
<li><a href="#org27f05d7">6. 数据结构</a>
<ul>
<li><a href="#org7147830">6.1. 任务表</a></li>
<li><a href="#org1fff159">6.2. 用户任务表</a></li>
<li><a href="#orgf93dbbd">6.3. 幸运分历史表（任务贡献表）</a></li>
<li><a href="#org86611d8">6.4. 天、地、人榜</a></li>
<li><a href="#orgdabf110">6.5. 主播当前幸运分 pt</a></li>
<li><a href="#org915947c">6.6. 当前任务</a></li>
<li><a href="#orgf2a1afa">6.7. 该用户是否收到过该任务需要的宝箱</a></li>
<li><a href="#orgc78d887">6.8. 主播在某个任务的任务进度</a></li>
<li><a href="#org8ef32a4">6.9. 任务详情</a></li>
</ul>
</li>
<li><a href="#orgb2c423e">7. 上线sql</a></li>
<li><a href="#org9f235bb">8. 上线模块</a></li>
<li><a href="#orge37bf80">9. <span class="done DONE">DONE</span> 待确定</a></li>
<li><a href="#org9e864a1">10. 注意事项</a></li>
</ul>
</div>
</div>

<div id="outline-container-org6417145" class="outline-2">
<h2 id="org6417145"><span class="section-number-2">1</span> 需求</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgc9a6b66" class="outline-3">
<h3 id="orgc9a6b66"><span class="section-number-3">1.1</span> A SS SSS SSS+ 多种集齐难度，每种难度对应一个分值，集齐后分值计入排行榜</h3>
</div>
<div id="outline-container-orgb9a5474" class="outline-3">
<h3 id="orgb9a5474"><span class="section-number-3">1.2</span> 榜单中昨日幸运直播间是啥？</h3>
</div>
<div id="outline-container-org2335fa5" class="outline-3">
<h3 id="org2335fa5"><span class="section-number-3">1.3</span> 榜单</h3>
</div>
<div id="outline-container-org487aad7" class="outline-3">
<h3 id="org487aad7"><span class="section-number-3">1.4</span> icon 弹窗</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>主播集齐进度<br></li>
<li>其他直播间集齐进度排行榜。如何排序？展示数量。仅展示前2名<br></li>
<li>金宝箱、银宝箱、铜宝箱按钮是干嘛的？<br></li>
</ul>
</div>
</div>
<div id="outline-container-orgd97780a" class="outline-3">
<h3 id="orgd97780a"><span class="section-number-3">1.5</span> 在本小时内，若有主播已集齐，则进行新一轮集齐任务。</h3>
</div>
<div id="outline-container-orgfb2c5da" class="outline-3">
<h3 id="orgfb2c5da"><span class="section-number-3">1.6</span> 集礼物。主播给用户送，用户给主播送，均计算在内</h3>
</div>
<div id="outline-container-org86be038" class="outline-3">
<h3 id="org86be038"><span class="section-number-3">1.7</span> 直播间最幸运用户头像框 + 最幸运家族背景图。如果主播是昨日排行榜第一名，加边框一天</h3>
</div>
<div id="outline-container-orgec9b00e" class="outline-3">
<h3 id="orgec9b00e"><span class="section-number-3">1.8</span> 两轮集齐有时间间隔 20s，20s之后才生成下一轮礼物集合</h3>
</div>
<div id="outline-container-orgeefb01a" class="outline-3">
<h3 id="orgeefb01a"><span class="section-number-3">1.9</span> 历史记录只提供 30条，分页 10个</h3>
</div>
<div id="outline-container-org7f41b58" class="outline-3">
<h3 id="org7f41b58"><span class="section-number-3">1.10</span> 贡献详情：按单价、贡献时间排序。仅x1，不可能x2以上。礼物图片x1</h3>
</div>
</div>

<div id="outline-container-orgd9ac3e9" class="outline-2">
<h2 id="orgd9ac3e9"><span class="section-number-2">2</span> 数据结构</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org9c0de77" class="outline-3">
<h3 id="org9c0de77"><span class="section-number-3">2.1</span> 更改吸金主播表</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5f8700;">alter</span> <span style="color: #5f8700;">table</span> <span style="color: #0087ff;">rich_anchor_contestants</span> change extra extra <span style="color: #af8700;">varchar</span>(2048) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span>;
<span style="color: #5f8700;">alter</span> <span style="color: #5f8700;">table</span> <span style="color: #0087ff;">rich_anchor_contestants</span> change `uid` `uid` <span style="color: #af8700;">varchar</span>(64) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'anchor uid'</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgec271f0" class="outline-3">
<h3 id="orgec271f0"><span class="section-number-3">2.2</span> 当前任务</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>任务表<br></li>
</ul>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5f8700;">CREATE</span> <span style="color: #5f8700;">TABLE</span> `box_gift_tasks` (
`id` <span style="color: #af8700;">int</span>(10) unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> AUTO_INCREMENT,
`event_name` <span style="color: #af8700;">varchar</span>(64) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`task_id` <span style="color: #af8700;">int</span>(11) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'event_name + task_id &#21807;&#19968;&#30830;&#23450;&#19968;&#20010;&#20219;&#21153;'</span>,
`<span style="color: #5f8700;">level</span>` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'difficulty level'</span>,
`pt` <span style="color: #af8700;">int</span>(10) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'&#29575;&#20808;&#23436;&#25104;&#35813;&#20219;&#21153;&#30340;&#20027;&#25773;&#21152;&#20998;'</span>,
`gifts` <span style="color: #af8700;">varchar</span>(1024) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span> COMMENT <span style="color: #00afaf;">'&#31036;&#29289;&#38598;&#21512;'</span>,
`is_finished` tinyint(4) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'&#35813;&#20219;&#21153;&#26159;&#21542;&#23436;&#25104;'</span>,
`finish_time` datetime <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'&#40664;&#35748;&#20026;None&#65292;&#34920;&#31034;&#26242;&#26410;&#26377;&#20027;&#25773;&#23436;&#25104;&#35813;&#20219;&#21153;'</span>,
`finish_uid` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span> COMMENT <span style="color: #00afaf;">'anchor uid'</span>,
`ctime` datetime <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`mtime` <span style="color: #af8700;">timestamp</span> <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span> <span style="color: #5f8700;">ON</span> <span style="color: #5f8700;">UPDATE</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span>,
<span style="color: #5f8700;">PRIMARY</span> <span style="color: #5f8700;">KEY</span> (`id`),
<span style="color: #5f8700;">KEY</span> `idx_event_name_task_id` (`event_name`, `task_id`)
) ENGINE = InnoDB AUTO_INCREMENT = 1 <span style="color: #5f8700;">DEFAULT</span> CHARSET = utf8mb4;
</pre>
</div>

<ul class="org-ul">
<li>当前任务<br></li>
</ul>
<p>
redis hash<br>
pre+event_name <br>
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #00afaf;">"task_id"</span>: 1589534600,
    <span style="color: #00afaf;">"level"</span>: <span style="color: #00afaf;">"SSS+"</span>,
    <span style="color: #00afaf;">"pt"</span>: 20,
    <span style="color: #00afaf;">"gifts"</span>: [
        {
            <span style="color: #00afaf;">"gift_id"</span>: 111,
            <span style="color: #00afaf;">"credits"</span>: 100,
            <span style="color: #00afaf;">"display_name"</span>: <span style="color: #00afaf;">"xxx"</span>,
            <span style="color: #00afaf;">"image_url"</span>: <span style="color: #00afaf;">"xxx"</span>,
            <span style="color: #00afaf;">"need_cnt"</span>: 10,
            <span style="color: #00afaf;">"box_gift_ids"</span>: [886, 887, 888]
        }
    ],
    <span style="color: #00afaf;">"ctime"</span>: 1589534600,
    <span style="color: #00afaf;">"is_finished"</span>: 0
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc928a70" class="outline-3">
<h3 id="orgc928a70"><span class="section-number-3">2.3</span> 收集历史表</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5f8700;">CREATE</span> <span style="color: #5f8700;">TABLE</span> `box_gift_collect_history` (
`id` <span style="color: #af8700;">int</span>(10) unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> AUTO_INCREMENT,
`event_name` <span style="color: #af8700;">varchar</span>(64) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`uid` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'knight uid'</span>,
`t_uid` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'anchor uid'</span>,
`task_id` <span style="color: #af8700;">int</span>(11) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">''</span>,
`gift_id` <span style="color: #af8700;">int</span>(10) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">''</span>,
`gift_cnt` <span style="color: #af8700;">int</span>(10) unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'number of gift'</span>,
`score` <span style="color: #af8700;">int</span>(11) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'gift score'</span>,
`is_enabled` tinyint(4) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'1'</span>,
`ctime` datetime <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`mtime` <span style="color: #af8700;">timestamp</span> <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span> <span style="color: #5f8700;">ON</span> <span style="color: #5f8700;">UPDATE</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span>,
<span style="color: #5f8700;">PRIMARY</span> <span style="color: #5f8700;">KEY</span> (`id`),
<span style="color: #5f8700;">KEY</span> `idx_event_name_task_id` (`event_name`, `task_id`)
) ENGINE = InnoDB AUTO_INCREMENT = 1 <span style="color: #5f8700;">DEFAULT</span> CHARSET = utf8mb4;
</pre>
</div>
</div>
</div>

<div id="outline-container-org83db5bb" class="outline-3">
<h3 id="org83db5bb"><span class="section-number-3">2.4</span> 个人任务完成情况</h3>
<div class="outline-text-3" id="text-2-4">
<p>
redis hash                           field      value<br>
pre + event_name + task_id + uid    gift_id      cnt<br>
</p>
</div>
</div>
</div>

<div id="outline-container-orgbe93721" class="outline-2">
<h2 id="orgbe93721"><span class="section-number-2">3</span> 实现</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgfc4f028" class="outline-3">
<h3 id="orgfc4f028"><span class="section-number-3">3.1</span> 集齐历史记录及贡献榜。礼物集齐的每小时历史，点击展示贡献名单</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>记录唯一标识：event_name + 年月日时<br></li>
</ul>
</div>
</div>
<div id="outline-container-orgc2d7102" class="outline-3">
<h3 id="orgc2d7102"><span class="section-number-3">3.2</span> 主播集齐次数日榜</h3>
</div>
<div id="outline-container-org4b5c523" class="outline-3">
<h3 id="org4b5c523"><span class="section-number-3">3.3</span> 本小时主播集齐度的一个排行榜</h3>
</div>
<div id="outline-container-org8dc77d5" class="outline-3">
<h3 id="org8dc77d5"><span class="section-number-3">3.4</span> 获取本小时礼物集合函数</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-org0cae88b" class="outline-4">
<h4 id="org0cae88b"><span class="section-number-4">3.4.1</span> 根据规则挑选本小时礼物集合</h4>
</div>
<div id="outline-container-org72a8c8d" class="outline-4">
<h4 id="org72a8c8d"><span class="section-number-4">3.4.2</span> 需要王珏提供函数：获取当前小时可开出的礼物，数据格式如下：</h4>
<div class="outline-text-4" id="text-3-4-2">
<div class="org-src-container">
<pre class="src src-python">treasure_chest_cacher.get_treasure_chest_hourly_special_gift_info(gift_id_list=gift_id_list, datetime=datetime.now())
</pre>
</div>
<div class="org-src-container">
<pre class="src src-js">[
    {
        <span style="color: #00afaf;">"gift_id"</span>: 111,
        <span style="color: #00afaf;">"box_gift_ids"</span>: [886, 887],
        <span style="color: #00afaf;">"gift_type"</span>: <span style="color: #00afaf;">"normal_gift"</span>
    }
]
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb67da63" class="outline-3">
<h3 id="orgb67da63"><span class="section-number-3">3.5</span> 收礼模块，用于集礼物</h3>
</div>

<div id="outline-container-orgcb95889" class="outline-3">
<h3 id="orgcb95889"><span class="section-number-3">3.6</span> 定时任务下发icon</h3>
<div class="outline-text-3" id="text-3-6">
<ul class="org-ul">
<li>当前礼物集合，和主播集齐的量<br></li>
<li>上一轮集齐的主播<br></li>
</ul>
</div>
</div>
<div id="outline-container-orgb03902b" class="outline-3">
<h3 id="orgb03902b"><span class="section-number-3">3.7</span> 直播间弹窗；获取本小说礼物集合http接口</h3>
<div class="outline-text-3" id="text-3-7">
<ul class="org-ul">
<li>本直播间集齐的量<br></li>
<li>！！其他直播间本轮的排行榜<br></li>
</ul>
</div>
</div>
<div id="outline-container-orgb7eee27" class="outline-3">
<h3 id="orgb7eee27"><span class="section-number-3">3.8</span> 直播间内最幸运用户头像框</h3>
</div>
<div id="outline-container-org7a61603" class="outline-3">
<h3 id="org7a61603"><span class="section-number-3">3.9</span> 任务创建</h3>
</div>
</div>

<div id="outline-container-org77da487" class="outline-2">
<h2 id="org77da487"><span class="section-number-2">4</span> 上线</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org1a1a3a5" class="outline-3">
<h3 id="org1a1a3a5"><span class="section-number-3">4.1</span> 确定主播给观众送礼能否不用。获取送礼队列时需要去掉 True。去掉一些日志</h3>
</div>
</div>


<div id="outline-container-org373a524" class="outline-2">
<h2 id="org373a524"><span class="section-number-2">5</span> 需求</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>根据幸运分划分段位，而非需要完成的任务<br></li>
<li>人运段位有3、4种礼物组合，任务难度如何表示。地运 B A S。天运 B A S<br></li>
<li>根据段位切换不同页面<br></li>
<li>没日榜了<br></li>
<li>直播间家族样式。直播间昨日最幸运用户<br></li>
<li>直播间弹窗展示<br></li>
<li>个人任务历史，需要根据段位吗？<br></li>
<li>每小时最好2min间歇期是否需要调大？<br></li>
<li>如果用户从人段位升级到地段位，升级完后，用户处于地段位，再过1s，地段位有人完成了。该用户没收到礼物会被扣分，逻辑是否有问题？<br></li>
<li>幸运度榜单分 3 个吗？<br></li>
<li>个人记录，如果用户某次任务没有搜集到礼物，改次任务还算在个人历史中吗？<br></li>
<li>送礼 +1(-10) 什么意思？<br></li>
</ul>
</div>
</div>

<div id="outline-container-org27f05d7" class="outline-2">
<h2 id="org27f05d7"><span class="section-number-2">6</span> 数据结构</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org7147830" class="outline-3">
<h3 id="org7147830"><span class="section-number-3">6.1</span> 任务表</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5f8700;">CREATE</span> <span style="color: #5f8700;">TABLE</span> `box_gift_v2_tasks` (
`id` <span style="color: #af8700;">int</span>(10) unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> AUTO_INCREMENT,
`event_name` <span style="color: #af8700;">varchar</span>(64) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`division` tinyint(4) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'0-&#20154;&#36816;&#32452; 1-&#22320;&#36816;&#32452; 2-&#22825;&#36816;&#32452;'</span>,
`task_id` bigint unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'event_name + task_id &#21807;&#19968;&#30830;&#23450;&#19968;&#20010;&#20219;&#21153;'</span>,
`<span style="color: #5f8700;">level</span>` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'difficulty level'</span>,
`pt` <span style="color: #af8700;">int</span>(10) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'&#29575;&#20808;&#23436;&#25104;&#35813;&#20219;&#21153;&#30340;&#20027;&#25773;&#21152;&#20998;'</span>,
`gifts` <span style="color: #af8700;">varchar</span>(2048) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span> COMMENT <span style="color: #00afaf;">'&#31036;&#29289;&#38598;&#21512;'</span>,
`status` <span style="color: #af8700;">varchar</span>(16) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span> COMMENT <span style="color: #00afaf;">'inprogress&#12289;settling&#12289;settled'</span>,
`finish_time` datetime <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'&#40664;&#35748;&#20026;None&#65292;&#34920;&#31034;&#26242;&#26410;&#26377;&#20027;&#25773;&#23436;&#25104;&#35813;&#20219;&#21153;'</span>,
`finish_uid` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span> COMMENT <span style="color: #00afaf;">'anchor uid'</span>,
`ctime` datetime <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`mtime` <span style="color: #af8700;">timestamp</span> <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span> <span style="color: #5f8700;">ON</span> <span style="color: #5f8700;">UPDATE</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span>,
<span style="color: #5f8700;">PRIMARY</span> <span style="color: #5f8700;">KEY</span> (`id`),
<span style="color: #5f8700;">UNIQUE</span> <span style="color: #5f8700;">KEY</span> `uniq_event_name_task_id` (`event_name`, `task_id`)
) ENGINE = InnoDB AUTO_INCREMENT = 1 <span style="color: #5f8700;">DEFAULT</span> CHARSET = utf8mb4;
</pre>
</div>
</div>
</div>

<div id="outline-container-org1fff159" class="outline-3">
<h3 id="org1fff159"><span class="section-number-3">6.2</span> 用户任务表</h3>
<div class="outline-text-3" id="text-6-2">
<p>
该表已结算和未结算的活动都会记录<br>
根据该表决定本阶段榜单、个人历史记录榜单<br>
对于关播这种情况：<br>
  人运：立马结算，再次开播重新生成<br>
  地运、天运：任务结束后统一结算<br>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5f8700;">CREATE</span> <span style="color: #5f8700;">TABLE</span> `box_gift_v2_tasks_history` (
`id` <span style="color: #af8700;">int</span>(10) unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> AUTO_INCREMENT,
`event_name` <span style="color: #af8700;">varchar</span>(64) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`uid` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'anchor uid'</span>,
`division` tinyint(4) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'&#22312;&#36827;&#34892;&#35813;&#20219;&#21153;&#26102;&#29992;&#25143;&#25152;&#22312;&#30340;&#27573;&#20301;&#65306;0-&#20154;&#36816;&#32452; 1-&#22320;&#36816;&#32452; 2-&#22825;&#36816;&#32452;'</span>,
`pt` <span style="color: #af8700;">int</span>(10) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'&#29992;&#25143;&#20998;&#37197;&#20219;&#21153;&#26102;&#30340;&#24184;&#36816;&#20998;'</span>,
`task_id` bigint unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'event_name + task_id &#21807;&#19968;&#30830;&#23450;&#19968;&#20010;&#20219;&#21153;'</span>,
`progress` <span style="color: #af8700;">varchar</span>(128) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span> COMMENT <span style="color: #00afaf;">'&#20219;&#21153;&#36827;&#24230; json'</span>,
`score` <span style="color: #af8700;">int</span>(11) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'&#31036;&#29289;&#20998;&#65292;&#29992;&#20110;&#25490;&#24207;'</span>,
`is_finished` tinyint(4) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'&#35813;&#20219;&#21153;&#26159;&#21542;&#32467;&#26463;'</span>,
`ctime` datetime <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`mtime` <span style="color: #af8700;">timestamp</span> <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span> <span style="color: #5f8700;">ON</span> <span style="color: #5f8700;">UPDATE</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span>,
<span style="color: #5f8700;">PRIMARY</span> <span style="color: #5f8700;">KEY</span> (`id`),
<span style="color: #5f8700;">UNIQUE</span> <span style="color: #5f8700;">KEY</span> `uniq_event_name_task_id` (`event_name`, `task_id`),
<span style="color: #5f8700;">KEY</span> `idx_event_name_uid` (`event_name`, `uid`)
) ENGINE = InnoDB AUTO_INCREMENT = 1 <span style="color: #5f8700;">DEFAULT</span> CHARSET = utf8mb4;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf93dbbd" class="outline-3">
<h3 id="orgf93dbbd"><span class="section-number-3">6.3</span> 幸运分历史表（任务贡献表）</h3>
<div class="outline-text-3" id="text-6-3">
<p>
只要存在 `type` 中的这 3 中情况，就会被记录下来。例如：用户当前 3 分，需要扣掉 5 分，会把 -5 分记录下来，而不是 -3 分。实际上用户幸运分最小为 0 分， 0分后就不能再减了。<br>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5f8700;">CREATE</span> <span style="color: #5f8700;">TABLE</span> `box_gift_v2_pt_history` (
`id` <span style="color: #af8700;">int</span>(10) unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> AUTO_INCREMENT,
`event_name` <span style="color: #af8700;">varchar</span>(64) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`<span style="color: #5f8700;">type</span>` tinyint(4) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'pt &#31867;&#22411;&#12290;1-&#21629;&#20013;&#23453;&#31665;&#20013;&#30340;&#29289;&#21697; 2-&#32456;&#32467;&#20219;&#21153; 3-&#35813;&#29992;&#25143;&#26159;&#21542;&#25910;&#21040;&#36807;&#35813;&#20219;&#21153;&#38656;&#35201;&#30340;&#23453;&#31665; 4-&#21319;&#32423;'</span>,
`uid` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">''</span> COMMENT <span style="color: #00afaf;">'knight uid&#12290;&#20165; type &#20026; 1 &#26102;&#26377;&#24847;&#20041;'</span>,
`t_uid` <span style="color: #af8700;">varchar</span>(32) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">'anchor uid'</span>,
`task_id` bigint unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> COMMENT <span style="color: #00afaf;">''</span>,
`gift_id` <span style="color: #af8700;">int</span>(10) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'&#20165; type &#20026; 1 &#26102;&#26377;&#24847;&#20041;'</span>,
`gift_cnt` <span style="color: #af8700;">int</span>(10) unsigned <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'&#20165; type &#20026; 1 &#26102;&#26377;&#24847;&#20041;'</span>,
`score` <span style="color: #af8700;">int</span>(11) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'gift score&#65292;&#20165; type &#20026; 1 &#26102;&#26377;&#24847;&#20041;'</span>,
`pt` <span style="color: #af8700;">int</span>(11) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'&#33719;&#24471;&#30340;&#24184;&#36816;&#20998;'</span>,
`is_enabled` tinyint(4) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'1'</span>,
`ctime` datetime <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>,
`mtime` <span style="color: #af8700;">timestamp</span> <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span> <span style="color: #5f8700;">ON</span> <span style="color: #5f8700;">UPDATE</span> <span style="color: #5f8700;">CURRENT_TIMESTAMP</span>,
<span style="color: #5f8700;">PRIMARY</span> <span style="color: #5f8700;">KEY</span> (`id`),
<span style="color: #5f8700;">KEY</span> `idx_event_name_t_uid` (`event_name`, `t_uid`),
<span style="color: #5f8700;">KEY</span> `idx_event_name_type_task_id_t_uid` (`event_name`, `<span style="color: #5f8700;">type</span>`, `task_id`, `t_uid`)
) ENGINE = InnoDB AUTO_INCREMENT = 1 <span style="color: #5f8700;">DEFAULT</span> CHARSET = utf8mb4;
</pre>
</div>
</div>
</div>

<div id="outline-container-org86611d8" class="outline-3">
<h3 id="org86611d8"><span class="section-number-3">6.4</span> 天、地、人榜</h3>
<div class="outline-text-3" id="text-6-4">
<p>
redis zset key                field    value<br>
pre + event_name + division    uid     score<br>
</p>
</div>
</div>

<div id="outline-container-orgdabf110" class="outline-3">
<h3 id="orgdabf110"><span class="section-number-3">6.5</span> 主播当前幸运分 pt</h3>
<div class="outline-text-3" id="text-6-5">
<p>
redis string key          value<br>
pre + event_name + uid    pt<br>
</p>
</div>
</div>

<div id="outline-container-org915947c" class="outline-3">
<h3 id="org915947c"><span class="section-number-3">6.6</span> 当前任务</h3>
<div class="outline-text-3" id="text-6-6">
<p>
redis string key                    value<br>
pre + event_name + division         task<br>
pre + event_name + uid              task<br>
</p>

<p>
is_outdated 表明任务已经过期，需要立马为该主播生成任务<br>
join_time 该用户加入任务时间。该字段待定<br>
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #00afaf;">"task_id"</span>: 1589534600,
    <span style="color: #00afaf;">"level"</span>: <span style="color: #00afaf;">"SSS+"</span>,
    <span style="color: #00afaf;">"division"</span>: 2,
    <span style="color: #00afaf;">"pt"</span>: 20,
    <span style="color: #00afaf;">"gifts"</span>: [
        {
            <span style="color: #00afaf;">"gift_id"</span>: 111,
            <span style="color: #00afaf;">"credits"</span>: 100,
            <span style="color: #00afaf;">"display_name"</span>: <span style="color: #00afaf;">"xxx"</span>,
            <span style="color: #00afaf;">"image_url"</span>: <span style="color: #00afaf;">"xxx"</span>,
            <span style="color: #00afaf;">"image_url2"</span>: <span style="color: #00afaf;">"xxx"</span>,
            <span style="color: #00afaf;">"need_cnt"</span>: 10,
            <span style="color: #00afaf;">"box_gift_ids"</span>: [886, 887, 888]
        }
    ],
    <span style="color: #00afaf;">"status"</span>: <span style="color: #00afaf;">"settling"</span>,
    <span style="color: #00afaf;">"is_outdated"</span>: 1,
    <span style="color: #00afaf;">"finish_time"</span>: 1593338646,
    <span style="color: #00afaf;">"finish_uid"</span>: <span style="color: #00afaf;">"u2572271555577408120001317"</span>,
    <span style="color: #00afaf;">"ctime"</span>: 1589534600,
    <span style="color: #00afaf;">"join_time"</span>: 1592917573
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf2a1afa" class="outline-3">
<h3 id="orgf2a1afa"><span class="section-number-3">6.7</span> 该用户是否收到过该任务需要的宝箱</h3>
<div class="outline-text-3" id="text-6-7">
<p>
加分模块需要记录金、银、铜 3 个宝箱所有可开出礼物的 3 个集合<br>
</p>

<p>
redis string key                     value<br>
pre + event_name + task_id + uid       1<br>
</p>
</div>
</div>

<div id="outline-container-orgc78d887" class="outline-3">
<h3 id="orgc78d887"><span class="section-number-3">6.8</span> 主播在某个任务的任务进度</h3>
<div class="outline-text-3" id="text-6-8">
<p>
redis hash key                       field      value<br>
pre + event_name + task_id + uid     gift_id    gift_cnt<br>
</p>
</div>
</div>

<div id="outline-container-org8ef32a4" class="outline-3">
<h3 id="org8ef32a4"><span class="section-number-3">6.9</span> 任务详情</h3>
<div class="outline-text-3" id="text-6-9">
<p>
redis string key              value<br>
pre + event_name + task_id    task<br>
</p>
</div>
</div>
</div>

<div id="outline-container-orgb2c423e" class="outline-2">
<h2 id="orgb2c423e"><span class="section-number-2">7</span> 上线sql</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5f8700;">alter</span> <span style="color: #5f8700;">table</span> <span style="color: #0087ff;">id_generator</span> change <span style="color: #5f8700;">column</span> `<span style="color: #5f8700;">name</span>` `<span style="color: #5f8700;">name</span>` <span style="color: #af8700;">varchar</span>(16) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span>;
<span style="color: #5f8700;">insert</span> <span style="color: #5f8700;">into</span> id_generator (`<span style="color: #5f8700;">name</span>`, `next_id`) <span style="color: #5f8700;">values</span> ("box_gifts_v2", 1);
<span style="color: #5f8700;">alter</span> <span style="color: #5f8700;">table</span> <span style="color: #0087ff;">box_gift_v2_tasks_history</span> <span style="color: #5f8700;">add</span> <span style="color: #5f8700;">column</span> `pt` <span style="color: #af8700;">int</span>(10) <span style="color: #5f8700;">NOT</span> <span style="color: #5f8700;">NULL</span> <span style="color: #5f8700;">DEFAULT</span> <span style="color: #00afaf;">'0'</span> COMMENT <span style="color: #00afaf;">'&#29992;&#25143;&#20998;&#37197;&#20219;&#21153;&#26102;&#30340;&#24184;&#36816;&#20998;'</span> <span style="color: #5f8700;">after</span> `division`;
</pre>
</div>
</div>
</div>


<div id="outline-container-org9f235bb" class="outline-2">
<h2 id="org9f235bb"><span class="section-number-2">8</span> 上线模块</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>http<br></li>
<li>schedule_event2<br></li>
<li>backend<br></li>
<li>backend_msg<br></li>
<li>admin<br></li>
<li>events-very_important<br></li>
<li>web_event 3项配置<br></li>
</ul>
</div>
</div>
<div id="outline-container-orge37bf80" class="outline-2">
<h2 id="orge37bf80"><span class="section-number-2">9</span> <span class="done DONE">DONE</span> 待确定</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>段位分 get_division_by_pt<br></li>
<li>升降级分 allocate_a_division_task_safe_for_user<br></li>
<li>结算时幸运分 settle_task<br></li>
<li>地运段位分 allocate_a_task_for_user<br></li>
</ul>
</div>
</div>
<div id="outline-container-org9e864a1" class="outline-2">
<h2 id="org9e864a1"><span class="section-number-2">10</span> 注意事项</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>修改宝箱中可开出的 gift_id 时，要注意更改代码 generate_task_for_uid 调整代码中写死的gift_id<br></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>本笔记系统由
    <a href="">时中贺</a> 搭建和维护，使用
    <a href="https://www.gnu.org/software/emacs/">Emacs</a>
    <a href="http://orgmode.org/">Org mode</a> 编辑和构建
    <br />
    email: shi_zhonghe@163.com
</p>
<script src="http://www.langdebuqing.com/css/jquery-2.1.3.min.js"></script>
<script src="http://www.langdebuqing.com/css/main.js"></script>
</div>
</body>
</html>
