<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 2020-01-15 Wed 12:03 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>关之原合战</title>
<meta name="generator" content="Org mode">
<meta name="author" content="时中贺">
<link rel="stylesheet" type="text/css" href="http://www.langdebuqing.com/css/style.css" />
<link rel="shortcut icon" href="http://www.langdebuqing.com/images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="preamble" class="status">
<div id="navbar">
    <ul>
        <li id="site-master"><a href="http://www.langdebuqing.com">浪的不轻</a></li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/gallery.html">Gallery</a> </li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/notebooks.html">Notebooks</a> </li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/links.html">Links</a> </li>
        <li><a class="navbar-item" href="http://www.langdebuqing.com/about.html">About</a> </li>
        <li class="search">
            <form action="http://google.com/search" method="get" accept-charset="utf-8">
                <input type="search" id="search" name="q" autocomplete="off" maxlength="30" placeholder="Google..">
                <input type="hidden" name="q" value="site:www.langdebuqing.com">
            </form>
        </li>
    </ul>
</div>
</div>
<div id="content">
<h1 class="title">关之原合战</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8bf54fc">1. 注意事项</a>
<ul>
<li><a href="#org3469add">1.1. <span class="done DONE">DONE</span> 4 个 http 接口</a></li>
<li><a href="#orgd7670c0">1.2. <span class="done DONE">DONE</span> 浮动 icon 的六个倒计时</a></li>
<li><a href="#org62f6cae">1.3. <span class="done DONE">DONE</span> 定时向指定主播发送弹幕</a></li>
<li><a href="#org5b9b1d6">1.4. <span class="done DONE">DONE</span> battle_points 调整为 win_points</a></li>
<li><a href="#orgdab7766">1.5. 攻防战一轮、二轮、王者战关系</a></li>
<li><a href="#orgc46155d">1.6. 关之原合战周二联调，新需求、联调</a></li>
<li><a href="#org1fb386e">1.7. CM 活动周二开发完成，周三提出新需求</a></li>
<li><a href="#orge9fd2dc">1.8. <span class="done DONE">DONE</span> 先拔头筹浮动 ICON 不展示积分排名</a></li>
<li><a href="#orgaa7aabb">1.9. <span class="done DONE">DONE</span> 榜单中用户注册后，显示在榜单中的用户积分为 0</a></li>
<li><a href="#org6b6565e">1.10. <span class="done DONE">DONE</span> 王座战取东军、西军前 5 名</a></li>
<li><a href="#orgee09fc5">1.11. <span class="done DONE">DONE</span> 王座战部分礼物加成，部分礼物不加成</a></li>
<li><a href="#org881f085">1.12. <span class="done DONE">DONE</span> 王座战浮动 ICON 文案显示不全</a></li>
<li><a href="#org25edf39">1.13. <span class="done DONE">DONE</span> 弹幕没发。布防时间结束后没发弹幕</a></li>
<li><a href="#orgb07d2f6">1.14. <span class="done DONE">DONE</span> 清理相关数据</a></li>
<li><a href="#org04aa57d">1.15. <span class="done DONE">DONE</span> fix bug: buff 加成</a></li>
<li><a href="#org5520bf3">1.16. <span class="done DONE">DONE</span> war_2019_offline_champion_battle_status 接口不返回未晋级主播</a></li>
<li><a href="#org5e6b57a">1.17. <span class="done DONE">DONE</span> 页面刷新慢。分数更新慢</a></li>
<li><a href="#org2f71d80">1.18. <span class="todo TODO">TODO</span> 冠军战晋级 3 个人，应该晋级 4 人</a></li>
<li><a href="#orga934495">1.19. <span class="done DONE">DONE</span> prestart_seconds 调整，所以需要调整文案</a></li>
<li><a href="#org8071dcf">1.20. <span class="done DONE">DONE</span> 王座战活动未开始不展示分数</a></li>
</ul>
</li>
<li><a href="#orgdaa6568">2. 重新测试时要数据清理</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8bf54fc" class="outline-2">
<h2 id="org8bf54fc"><span class="section-number-2">1</span> 注意事项</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3469add" class="outline-3">
<h3 id="org3469add"><span class="section-number-3">1.1</span> <span class="done DONE">DONE</span> 4 个 http 接口</h3>
<div class="outline-text-3" id="text-1-1">
<p>
先拔头筹、攻防战一轮二轮、王座战排行榜功能接口<br>
</p>
<ul class="org-ul">
<li>api.events_v2.common_anchor.both_rank<br></li>
<li>api.events_v2.common_anchor.both_rank_status<br></li>
<li>api.events_v2.common_anchor.war_2019_champion_rank<br></li>
<li>api.events_v2.common_anchor.war_2019_champion_rank_status<br></li>
</ul>
</div>
</div>

<div id="outline-container-orgd7670c0" class="outline-3">
<h3 id="orgd7670c0"><span class="section-number-3">1.2</span> <span class="done DONE">DONE</span> 浮动 icon 的六个倒计时</h3>
<div class="outline-text-3" id="text-1-2">
<p>
攻防战一轮和二轮浮动 icon 倒计时<br>
需要获取攻防战一轮、二轮 2 个活动的配置文件中的活动攻防起止时间，判断主播属于哪方，调整 floating_icons http 接口和 floating_icons 的定时事件<br>
</p>
<ul class="org-ul">
<li>东军布阵时间 剩余 04:59<br></li>
<li>西军进攻时间 剩余 09:59<br></li>
<li>东军防守时间 剩余 09:59<br></li>
</ul>
</div>
</div>

<div id="outline-container-org62f6cae" class="outline-3">
<h3 id="org62f6cae"><span class="section-number-3">1.3</span> <span class="done DONE">DONE</span> 定时向指定主播发送弹幕</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>弹幕<br>
<ol class="org-ol">
<li>先手开始布阵  先攻軍が布陣開始！<br></li>
<li>后手开始进攻  後攻軍が攻撃開始！<br></li>
<li>先手开始防御  先攻軍が防御開始！<br></li>
<li>后手开始布阵  後攻軍が布陣開始！<br></li>
<li>先手开始进攻  先攻軍が攻撃開始！<br></li>
<li>后手开始防御  後攻軍が防御開始！<br></li>
</ol></li>
</ul>

<p>
東軍布陣タイム<br>
西軍攻撃タイム<br>
東軍防御タイム<br>
</p>

<p>
西軍布陣タイム<br>
東軍攻撃タイム<br>
西軍防御タイム<br>
</p>

<p>
残り04:00<br>
</p>

<ul class="org-ul">
<li><p>
websocket 消息 json<br>
</p>
<div class="org-src-container">
<pre class="src src-json">{
    "command": "MNY",
    "param": "MSG",
    "msg_id": "xxx",
    "data": {
        "room_id": "xxx",
        "msg": u"东军开始布阵",
        "type": "fanout",
        "mny_msg_type": 4,
        "uid": "xxx",
        "user": {}
    }
}
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org5b9b1d6" class="outline-3">
<h3 id="org5b9b1d6"><span class="section-number-3">1.4</span> <span class="done DONE">DONE</span> battle_points 调整为 win_points</h3>
</div>
<div id="outline-container-orgdab7766" class="outline-3">
<h3 id="orgdab7766"><span class="section-number-3">1.5</span> 攻防战一轮、二轮、王者战关系</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>攻防战一轮、二轮各单独一个榜单，之间无继承关系<br></li>
<li>主播在王座战的初始战力 = 攻防战一轮战力 + 攻防战二轮战力<br></li>
</ul>
</div>
</div>


<div id="outline-container-orgc46155d" class="outline-3">
<h3 id="orgc46155d"><span class="section-number-3">1.6</span> 关之原合战周二联调，新需求、联调</h3>
</div>
<div id="outline-container-org1fb386e" class="outline-3">
<h3 id="org1fb386e"><span class="section-number-3">1.7</span> CM 活动周二开发完成，周三提出新需求</h3>
</div>

<div id="outline-container-orge9fd2dc" class="outline-3">
<h3 id="orge9fd2dc"><span class="section-number-3">1.8</span> <span class="done DONE">DONE</span> 先拔头筹浮动 ICON 不展示积分排名</h3>
</div>
<div id="outline-container-orgaa7aabb" class="outline-3">
<h3 id="orgaa7aabb"><span class="section-number-3">1.9</span> <span class="done DONE">DONE</span> 榜单中用户注册后，显示在榜单中的用户积分为 0</h3>
</div>
<div id="outline-container-org6b6565e" class="outline-3">
<h3 id="org6b6565e"><span class="section-number-3">1.10</span> <span class="done DONE">DONE</span> 王座战取东军、西军前 5 名</h3>
</div>

<div id="outline-container-orgee09fc5" class="outline-3">
<h3 id="orgee09fc5"><span class="section-number-3">1.11</span> <span class="done DONE">DONE</span> 王座战部分礼物加成，部分礼物不加成</h3>
</div>
<div id="outline-container-org881f085" class="outline-3">
<h3 id="org881f085"><span class="section-number-3">1.12</span> <span class="done DONE">DONE</span> 王座战浮动 ICON 文案显示不全</h3>
</div>
<div id="outline-container-org25edf39" class="outline-3">
<h3 id="org25edf39"><span class="section-number-3">1.13</span> <span class="done DONE">DONE</span> 弹幕没发。布防时间结束后没发弹幕</h3>
</div>
<div id="outline-container-orgb07d2f6" class="outline-3">
<h3 id="orgb07d2f6"><span class="section-number-3">1.14</span> <span class="done DONE">DONE</span> 清理相关数据</h3>
</div>
<div id="outline-container-org04aa57d" class="outline-3">
<h3 id="org04aa57d"><span class="section-number-3">1.15</span> <span class="done DONE">DONE</span> fix bug: buff 加成</h3>
</div>
<div id="outline-container-org5520bf3" class="outline-3">
<h3 id="org5520bf3"><span class="section-number-3">1.16</span> <span class="done DONE">DONE</span> war_2019_offline_champion_battle_status 接口不返回未晋级主播</h3>
</div>
<div id="outline-container-org5e6b57a" class="outline-3">
<h3 id="org5e6b57a"><span class="section-number-3">1.17</span> <span class="done DONE">DONE</span> 页面刷新慢。分数更新慢</h3>
</div>
<div id="outline-container-org2f71d80" class="outline-3">
<h3 id="org2f71d80"><span class="section-number-3">1.18</span> <span class="todo TODO">TODO</span> 冠军战晋级 3 个人，应该晋级 4 人</h3>
</div>
<div id="outline-container-orga934495" class="outline-3">
<h3 id="orga934495"><span class="section-number-3">1.19</span> <span class="done DONE">DONE</span> prestart_seconds 调整，所以需要调整文案</h3>
</div>
<div id="outline-container-org8071dcf" class="outline-3">
<h3 id="org8071dcf"><span class="section-number-3">1.20</span> <span class="done DONE">DONE</span> 王座战活动未开始不展示分数</h3>
</div>
</div>
<div id="outline-container-orgdaa6568" class="outline-2">
<h2 id="orgdaa6568"><span class="section-number-2">2</span> 重新测试时要数据清理</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-shell">$ redis-cli -h 10.0.110.115 -p 6370 -n 10 del events_v2_common_anchors_rank_zset_war_2019_offline_first_battle events_v2_common_anchors_rank_zset_war_2019_offline_second_battle_1 events_v2_common_anchors_rank_zset_war_2019_offline_second_battle_2 events_v2_common_anchors_rank_zset_war_2019_offline_champion_battle

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 del events_v2_common_anchors_rank_cache_war_2019_offline_first_battle events_v2_common_anchors_rank_cache_war_2019_offline_second_battle_1 events_v2_common_anchors_rank_cache_war_2019_offline_second_battle_2 events_v2_common_anchors_rank_cache_war_2019_offline_champion_battle

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_first_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_second_battle_1_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_second_battle_2_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_champion_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_first_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_second_battle_1_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_second_battle_2_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_champion_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 del promote_by_setting_war_2019_first_3_war_2019_offline_first_battle promote_by_setting_war_2019_offline_first_battle_war_2019_offline_second_battle_1 promote_by_setting_war_2019_offline_second_battle_1_war_2019_offline_second_battle_2 promote_by_setting_war_2019_offline_second_battle_2_war_2019_offline_champion_battle


mysql&gt; delete from common_anchors_rank_score_history where event_name<span style="color: #5f8700;"> in</span> (<span style="color: #00afaf;">'war_2019_offline_first_battle'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_1'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_2'</span>, <span style="color: #00afaf;">'war_2019_offline_champion_battle'</span>);

mysql&gt; delete from common_anchor_knights_rank where event_name<span style="color: #5f8700;"> in</span> (<span style="color: #00afaf;">'war_2019_offline_first_battle'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_1'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_2'</span>, <span style="color: #00afaf;">'war_2019_offline_champion_battle'</span>);

mysql&gt; delete from common_anchors_rank where event_name<span style="color: #5f8700;"> in</span> (<span style="color: #00afaf;">'war_2019_offline_first_battle'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_1'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_2'</span>, <span style="color: #00afaf;">'war_2019_offline_champion_battle'</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>本笔记系统由
    <a href="">时中贺</a> 搭建和维护，使用
    <a href="https://www.gnu.org/software/emacs/">Emacs</a>
    <a href="http://orgmode.org/">Org mode</a> 编辑和构建
    <br />
    email: shi_zhonghe@163.com
</p>
<script src="http://www.langdebuqing.com/css/jquery-2.1.3.min.js"></script>
<script src="http://www.langdebuqing.com/css/main.js"></script>
</div>
</body>
</html>
