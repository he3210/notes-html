<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 2021-05-06 Thu 15:27 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>关之原合战</title>
<meta name="generator" content="Org mode">
<meta name="author" content="时中贺">
<link rel="stylesheet" type="text/css" href="file:/Users/he/notes/html/css/style.css" />
<link rel="shortcut icon" href="file:/Users/he/notes/html/images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="preamble" class="status">
<div id="navbar">
    <ul>
        <li id="site-master"><a href="file:/Users/he/notes/html/index.html">浪的不轻</a></li>
        <li><a class="navbar-item" href="file:/Users/he/notes/html/gallery.html">Gallery</a> </li>
        <li><a class="navbar-item" href="file:/Users/he/notes/html/notebooks.html">Notebooks</a> </li>
        <li><a class="navbar-item" href="file:/Users/he/notes/html/links.html">Links</a> </li>
        <li><a class="navbar-item" href="file:/Users/he/notes/html/about.html">About</a> </li>
        <li class="search">
            <form action="http://google.com/search" method="get" accept-charset="utf-8">
                <input type="search" id="search" name="q" autocomplete="off" maxlength="30" placeholder="Google..">
                <input type="hidden" name="q" value="site:www.langdebuqing.com">
            </form>
        </li>
    </ul>
</div>
</div>
<div id="content">
<h1 class="title">关之原合战</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgdaee97b">1. 注意事项</a>
<ul>
<li><a href="#orgf2ebbb9">1.1. <span class="done DONE">DONE</span> 4 个 http 接口</a></li>
<li><a href="#org51d6aff">1.2. <span class="done DONE">DONE</span> 浮动 icon 的六个倒计时</a></li>
<li><a href="#orgb2571e8">1.3. <span class="done DONE">DONE</span> 定时向指定主播发送弹幕</a></li>
<li><a href="#orgfb86df6">1.4. <span class="done DONE">DONE</span> battle_points 调整为 win_points</a></li>
<li><a href="#orgb954500">1.5. 攻防战一轮、二轮、王者战关系</a></li>
<li><a href="#orgf251209">1.6. 关之原合战周二联调，新需求、联调</a></li>
<li><a href="#org06024cf">1.7. CM 活动周二开发完成，周三提出新需求</a></li>
<li><a href="#org6a89257">1.8. <span class="done DONE">DONE</span> 先拔头筹浮动 ICON 不展示积分排名</a></li>
<li><a href="#orge005972">1.9. <span class="done DONE">DONE</span> 榜单中用户注册后，显示在榜单中的用户积分为 0</a></li>
<li><a href="#org0fe1641">1.10. <span class="done DONE">DONE</span> 王座战取东军、西军前 5 名</a></li>
<li><a href="#orgaca12af">1.11. <span class="done DONE">DONE</span> 王座战部分礼物加成，部分礼物不加成</a></li>
<li><a href="#orge96c117">1.12. <span class="done DONE">DONE</span> 王座战浮动 ICON 文案显示不全</a></li>
<li><a href="#org4d2af15">1.13. <span class="done DONE">DONE</span> 弹幕没发。布防时间结束后没发弹幕</a></li>
<li><a href="#org535f8cb">1.14. <span class="done DONE">DONE</span> 清理相关数据</a></li>
<li><a href="#orga0f78dd">1.15. <span class="done DONE">DONE</span> fix bug: buff 加成</a></li>
<li><a href="#org946790a">1.16. <span class="done DONE">DONE</span> war_2019_offline_champion_battle_status 接口不返回未晋级主播</a></li>
<li><a href="#org696642d">1.17. <span class="done DONE">DONE</span> 页面刷新慢。分数更新慢</a></li>
<li><a href="#orgd1c2cde">1.18. <span class="todo TODO">TODO</span> 冠军战晋级 3 个人，应该晋级 4 人</a></li>
<li><a href="#org2f8fbb3">1.19. <span class="done DONE">DONE</span> prestart_seconds 调整，所以需要调整文案</a></li>
<li><a href="#org948fce7">1.20. <span class="done DONE">DONE</span> 王座战活动未开始不展示分数</a></li>
</ul>
</li>
<li><a href="#orgeb2c361">2. 重新测试时要数据清理</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgdaee97b" class="outline-2">
<h2 id="orgdaee97b"><span class="section-number-2">1</span> 注意事项</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgf2ebbb9" class="outline-3">
<h3 id="orgf2ebbb9"><span class="section-number-3">1.1</span> <span class="done DONE">DONE</span> 4 个 http 接口</h3>
<div class="outline-text-3" id="text-1-1">
<p>
先拔头筹、攻防战一轮二轮、王座战排行榜功能接口<br>
</p>
<ul class="org-ul">
<li>api.events_v2.common_anchor.both_rank<br></li>
<li>api.events_v2.common_anchor.both_rank_status<br></li>
<li>api.events_v2.common_anchor.war_2019_champion_rank<br></li>
<li>api.events_v2.common_anchor.war_2019_champion_rank_status<br></li>
</ul>
</div>
</div>

<div id="outline-container-org51d6aff" class="outline-3">
<h3 id="org51d6aff"><span class="section-number-3">1.2</span> <span class="done DONE">DONE</span> 浮动 icon 的六个倒计时</h3>
<div class="outline-text-3" id="text-1-2">
<p>
攻防战一轮和二轮浮动 icon 倒计时<br>
需要获取攻防战一轮、二轮 2 个活动的配置文件中的活动攻防起止时间，判断主播属于哪方，调整 floating_icons http 接口和 floating_icons 的定时事件<br>
</p>
<ul class="org-ul">
<li>东军布阵时间 剩余 04:59<br></li>
<li>西军进攻时间 剩余 09:59<br></li>
<li>东军防守时间 剩余 09:59<br></li>
</ul>
</div>
</div>

<div id="outline-container-orgb2571e8" class="outline-3">
<h3 id="orgb2571e8"><span class="section-number-3">1.3</span> <span class="done DONE">DONE</span> 定时向指定主播发送弹幕</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>弹幕<br>
<ol class="org-ol">
<li>先手开始布阵  先攻軍が布陣開始！<br></li>
<li>后手开始进攻  後攻軍が攻撃開始！<br></li>
<li>先手开始防御  先攻軍が防御開始！<br></li>
<li>后手开始布阵  後攻軍が布陣開始！<br></li>
<li>先手开始进攻  先攻軍が攻撃開始！<br></li>
<li>后手开始防御  後攻軍が防御開始！<br></li>
</ol></li>
</ul>

<p>
東軍布陣タイム<br>
西軍攻撃タイム<br>
東軍防御タイム<br>
</p>

<p>
西軍布陣タイム<br>
東軍攻撃タイム<br>
西軍防御タイム<br>
</p>

<p>
残り04:00<br>
</p>

<ul class="org-ul">
<li><p>
websocket 消息 json<br>
</p>
<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #5f8700;">"command"</span>: <span style="color: #00afaf;">"MNY"</span>,
    <span style="color: #5f8700;">"param"</span>: <span style="color: #00afaf;">"MSG"</span>,
    <span style="color: #5f8700;">"msg_id"</span>: <span style="color: #00afaf;">"xxx"</span>,
    <span style="color: #5f8700;">"data"</span>: {
        <span style="color: #5f8700;">"room_id"</span>: <span style="color: #00afaf;">"xxx"</span>,
        <span style="color: #5f8700;">"msg"</span>: u<span style="color: #00afaf;">"&#19996;&#20891;&#24320;&#22987;&#24067;&#38453;"</span>,
        <span style="color: #5f8700;">"type"</span>: <span style="color: #00afaf;">"fanout"</span>,
        <span style="color: #5f8700;">"mny_msg_type"</span>: <span style="color: #00afaf;">4</span>,
        <span style="color: #5f8700;">"uid"</span>: <span style="color: #00afaf;">"xxx"</span>,
        <span style="color: #5f8700;">"user"</span>: {}
    }
}
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgfb86df6" class="outline-3">
<h3 id="orgfb86df6"><span class="section-number-3">1.4</span> <span class="done DONE">DONE</span> battle_points 调整为 win_points</h3>
</div>
<div id="outline-container-orgb954500" class="outline-3">
<h3 id="orgb954500"><span class="section-number-3">1.5</span> 攻防战一轮、二轮、王者战关系</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>攻防战一轮、二轮各单独一个榜单，之间无继承关系<br></li>
<li>主播在王座战的初始战力 = 攻防战一轮战力 + 攻防战二轮战力<br></li>
</ul>
</div>
</div>


<div id="outline-container-orgf251209" class="outline-3">
<h3 id="orgf251209"><span class="section-number-3">1.6</span> 关之原合战周二联调，新需求、联调</h3>
</div>
<div id="outline-container-org06024cf" class="outline-3">
<h3 id="org06024cf"><span class="section-number-3">1.7</span> CM 活动周二开发完成，周三提出新需求</h3>
</div>

<div id="outline-container-org6a89257" class="outline-3">
<h3 id="org6a89257"><span class="section-number-3">1.8</span> <span class="done DONE">DONE</span> 先拔头筹浮动 ICON 不展示积分排名</h3>
</div>
<div id="outline-container-orge005972" class="outline-3">
<h3 id="orge005972"><span class="section-number-3">1.9</span> <span class="done DONE">DONE</span> 榜单中用户注册后，显示在榜单中的用户积分为 0</h3>
</div>
<div id="outline-container-org0fe1641" class="outline-3">
<h3 id="org0fe1641"><span class="section-number-3">1.10</span> <span class="done DONE">DONE</span> 王座战取东军、西军前 5 名</h3>
</div>

<div id="outline-container-orgaca12af" class="outline-3">
<h3 id="orgaca12af"><span class="section-number-3">1.11</span> <span class="done DONE">DONE</span> 王座战部分礼物加成，部分礼物不加成</h3>
</div>
<div id="outline-container-orge96c117" class="outline-3">
<h3 id="orge96c117"><span class="section-number-3">1.12</span> <span class="done DONE">DONE</span> 王座战浮动 ICON 文案显示不全</h3>
</div>
<div id="outline-container-org4d2af15" class="outline-3">
<h3 id="org4d2af15"><span class="section-number-3">1.13</span> <span class="done DONE">DONE</span> 弹幕没发。布防时间结束后没发弹幕</h3>
</div>
<div id="outline-container-org535f8cb" class="outline-3">
<h3 id="org535f8cb"><span class="section-number-3">1.14</span> <span class="done DONE">DONE</span> 清理相关数据</h3>
</div>
<div id="outline-container-orga0f78dd" class="outline-3">
<h3 id="orga0f78dd"><span class="section-number-3">1.15</span> <span class="done DONE">DONE</span> fix bug: buff 加成</h3>
</div>
<div id="outline-container-org946790a" class="outline-3">
<h3 id="org946790a"><span class="section-number-3">1.16</span> <span class="done DONE">DONE</span> war_2019_offline_champion_battle_status 接口不返回未晋级主播</h3>
</div>
<div id="outline-container-org696642d" class="outline-3">
<h3 id="org696642d"><span class="section-number-3">1.17</span> <span class="done DONE">DONE</span> 页面刷新慢。分数更新慢</h3>
</div>
<div id="outline-container-orgd1c2cde" class="outline-3">
<h3 id="orgd1c2cde"><span class="section-number-3">1.18</span> <span class="todo TODO">TODO</span> 冠军战晋级 3 个人，应该晋级 4 人</h3>
</div>
<div id="outline-container-org2f8fbb3" class="outline-3">
<h3 id="org2f8fbb3"><span class="section-number-3">1.19</span> <span class="done DONE">DONE</span> prestart_seconds 调整，所以需要调整文案</h3>
</div>
<div id="outline-container-org948fce7" class="outline-3">
<h3 id="org948fce7"><span class="section-number-3">1.20</span> <span class="done DONE">DONE</span> 王座战活动未开始不展示分数</h3>
</div>
</div>
<div id="outline-container-orgeb2c361" class="outline-2">
<h2 id="orgeb2c361"><span class="section-number-2">2</span> 重新测试时要数据清理</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-shell">$ redis-cli -h 10.0.110.115 -p 6370 -n 10 del events_v2_common_anchors_rank_zset_war_2019_offline_first_battle events_v2_common_anchors_rank_zset_war_2019_offline_second_battle_1 events_v2_common_anchors_rank_zset_war_2019_offline_second_battle_2 events_v2_common_anchors_rank_zset_war_2019_offline_champion_battle

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 del events_v2_common_anchors_rank_cache_war_2019_offline_first_battle events_v2_common_anchors_rank_cache_war_2019_offline_second_battle_1 events_v2_common_anchors_rank_cache_war_2019_offline_second_battle_2 events_v2_common_anchors_rank_cache_war_2019_offline_champion_battle

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_first_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_second_battle_1_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_second_battle_2_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_zset_war_2019_offline_champion_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_first_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_second_battle_1_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_second_battle_2_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 keys <span style="color: #00afaf;">"events_v2_common_anchor_knights_rank_cache_war_2019_offline_champion_battle_*"</span> | xargs redis-cli -h 10.0.110.115 -p 6370 -n 10 del

$ redis-cli -h 10.0.110.115 -p 6370 -n 10 del promote_by_setting_war_2019_first_3_war_2019_offline_first_battle promote_by_setting_war_2019_offline_first_battle_war_2019_offline_second_battle_1 promote_by_setting_war_2019_offline_second_battle_1_war_2019_offline_second_battle_2 promote_by_setting_war_2019_offline_second_battle_2_war_2019_offline_champion_battle


mysql&gt; delete from common_anchors_rank_score_history where event_name<span style="color: #5f8700;"> in</span> (<span style="color: #00afaf;">'war_2019_offline_first_battle'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_1'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_2'</span>, <span style="color: #00afaf;">'war_2019_offline_champion_battle'</span>);

mysql&gt; delete from common_anchor_knights_rank where event_name<span style="color: #5f8700;"> in</span> (<span style="color: #00afaf;">'war_2019_offline_first_battle'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_1'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_2'</span>, <span style="color: #00afaf;">'war_2019_offline_champion_battle'</span>);

mysql&gt; delete from common_anchors_rank where event_name<span style="color: #5f8700;"> in</span> (<span style="color: #00afaf;">'war_2019_offline_first_battle'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_1'</span>, <span style="color: #00afaf;">'war_2019_offline_second_battle_2'</span>, <span style="color: #00afaf;">'war_2019_offline_champion_battle'</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>本笔记系统由
    <a href="">时中贺</a> 搭建和维护，使用
    <a href="https://www.gnu.org/software/emacs/">Emacs</a>
    <a href="http://orgmode.org/">Org mode</a> 编辑和构建
    <br />
    email: shi_zhonghe@163.com
</p>
<script src="file:/Users/he/notes/html/css/jquery-2.1.3.min.js"></script>
<script src="file:/Users/he/notes/html/css/main.js"></script>
</div>
</body>
</html>
